{"ast":null,"code":"import { __assign, __extends } from \"tslib\";\nimport { dep, KeyTrie } from 'optimism';\nimport { equal } from '@wry/equality';\nimport { isReference, makeReference, DeepMerger, maybeDeepFreeze, canUseWeakMap } from \"../../utilities/index.js\";\nimport { hasOwn, fieldNameFromStoreName } from \"./helpers.js\";\nvar DELETE = Object.create(null);\n\nvar delModifier = function () {\n  return DELETE;\n};\n\nvar EntityStore = function () {\n  function EntityStore(policies, group) {\n    var _this = this;\n\n    this.policies = policies;\n    this.group = group;\n    this.data = Object.create(null);\n    this.rootIds = Object.create(null);\n    this.refs = Object.create(null);\n\n    this.getFieldValue = function (objectOrReference, storeFieldName) {\n      return maybeDeepFreeze(isReference(objectOrReference) ? _this.get(objectOrReference.__ref, storeFieldName) : objectOrReference && objectOrReference[storeFieldName]);\n    };\n\n    this.canRead = function (objOrRef) {\n      return isReference(objOrRef) ? _this.has(objOrRef.__ref) : typeof objOrRef === \"object\";\n    };\n\n    this.toReference = function (objOrIdOrRef, mergeIntoStore) {\n      if (typeof objOrIdOrRef === \"string\") {\n        return makeReference(objOrIdOrRef);\n      }\n\n      if (isReference(objOrIdOrRef)) {\n        return objOrIdOrRef;\n      }\n\n      var id = _this.policies.identify(objOrIdOrRef)[0];\n\n      if (id) {\n        var ref = makeReference(id);\n\n        if (mergeIntoStore) {\n          _this.merge(id, objOrIdOrRef);\n        }\n\n        return ref;\n      }\n    };\n  }\n\n  EntityStore.prototype.toObject = function () {\n    return __assign({}, this.data);\n  };\n\n  EntityStore.prototype.has = function (dataId) {\n    return this.lookup(dataId, true) !== void 0;\n  };\n\n  EntityStore.prototype.get = function (dataId, fieldName) {\n    this.group.depend(dataId, fieldName);\n\n    if (hasOwn.call(this.data, dataId)) {\n      var storeObject = this.data[dataId];\n\n      if (storeObject && hasOwn.call(storeObject, fieldName)) {\n        return storeObject[fieldName];\n      }\n    }\n\n    if (fieldName === \"__typename\" && hasOwn.call(this.policies.rootTypenamesById, dataId)) {\n      return this.policies.rootTypenamesById[dataId];\n    }\n\n    if (this instanceof Layer) {\n      return this.parent.get(dataId, fieldName);\n    }\n  };\n\n  EntityStore.prototype.lookup = function (dataId, dependOnExistence) {\n    if (dependOnExistence) this.group.depend(dataId, \"__exists\");\n    return hasOwn.call(this.data, dataId) ? this.data[dataId] : this instanceof Layer ? this.parent.lookup(dataId, dependOnExistence) : void 0;\n  };\n\n  EntityStore.prototype.merge = function (dataId, incoming) {\n    var _this = this;\n\n    var existing = this.lookup(dataId);\n    var merged = new DeepMerger(storeObjectReconciler).merge(existing, incoming);\n    this.data[dataId] = merged;\n\n    if (merged !== existing) {\n      delete this.refs[dataId];\n\n      if (this.group.caching) {\n        var fieldsToDirty_1 = Object.create(null);\n        if (!existing) fieldsToDirty_1.__exists = 1;\n        Object.keys(incoming).forEach(function (storeFieldName) {\n          if (!existing || existing[storeFieldName] !== merged[storeFieldName]) {\n            fieldsToDirty_1[fieldNameFromStoreName(storeFieldName)] = 1;\n\n            if (merged[storeFieldName] === void 0 && !(_this instanceof Layer)) {\n              delete merged[storeFieldName];\n            }\n          }\n        });\n        Object.keys(fieldsToDirty_1).forEach(function (fieldName) {\n          return _this.group.dirty(dataId, fieldName);\n        });\n      }\n    }\n  };\n\n  EntityStore.prototype.modify = function (dataId, fields) {\n    var _this = this;\n\n    var storeObject = this.lookup(dataId);\n\n    if (storeObject) {\n      var changedFields_1 = Object.create(null);\n      var needToMerge_1 = false;\n      var allDeleted_1 = true;\n\n      var readField_1 = function (fieldNameOrOptions, from) {\n        return _this.policies.readField(typeof fieldNameOrOptions === \"string\" ? {\n          fieldName: fieldNameOrOptions,\n          from: from || makeReference(dataId)\n        } : fieldNameOrOptions, {\n          store: _this\n        });\n      };\n\n      Object.keys(storeObject).forEach(function (storeFieldName) {\n        var fieldName = fieldNameFromStoreName(storeFieldName);\n        var fieldValue = storeObject[storeFieldName];\n        if (fieldValue === void 0) return;\n        var modify = typeof fields === \"function\" ? fields : fields[storeFieldName] || fields[fieldName];\n\n        if (modify) {\n          var newValue = modify === delModifier ? DELETE : modify(maybeDeepFreeze(fieldValue), {\n            DELETE: DELETE,\n            fieldName: fieldName,\n            storeFieldName: storeFieldName,\n            isReference: isReference,\n            toReference: _this.toReference,\n            canRead: _this.canRead,\n            readField: readField_1\n          });\n          if (newValue === DELETE) newValue = void 0;\n\n          if (newValue !== fieldValue) {\n            changedFields_1[storeFieldName] = newValue;\n            needToMerge_1 = true;\n            fieldValue = newValue;\n          }\n        }\n\n        if (fieldValue !== void 0) {\n          allDeleted_1 = false;\n        }\n      });\n\n      if (needToMerge_1) {\n        this.merge(dataId, changedFields_1);\n\n        if (allDeleted_1) {\n          if (this instanceof Layer) {\n            this.data[dataId] = void 0;\n          } else {\n            delete this.data[dataId];\n          }\n\n          this.group.dirty(dataId, \"__exists\");\n        }\n\n        return true;\n      }\n    }\n\n    return false;\n  };\n\n  EntityStore.prototype.delete = function (dataId, fieldName, args) {\n    var _a;\n\n    var storeObject = this.lookup(dataId);\n\n    if (storeObject) {\n      var typename = this.getFieldValue(storeObject, \"__typename\");\n      var storeFieldName = fieldName && args ? this.policies.getStoreFieldName({\n        typename: typename,\n        fieldName: fieldName,\n        args: args\n      }) : fieldName;\n      return this.modify(dataId, storeFieldName ? (_a = {}, _a[storeFieldName] = delModifier, _a) : delModifier);\n    }\n\n    return false;\n  };\n\n  EntityStore.prototype.evict = function (options) {\n    var evicted = false;\n\n    if (options.id) {\n      if (hasOwn.call(this.data, options.id)) {\n        evicted = this.delete(options.id, options.fieldName, options.args);\n      }\n\n      if (this instanceof Layer) {\n        evicted = this.parent.evict(options) || evicted;\n      }\n\n      if (options.fieldName || evicted) {\n        this.group.dirty(options.id, options.fieldName || \"__exists\");\n      }\n    }\n\n    return evicted;\n  };\n\n  EntityStore.prototype.clear = function () {\n    this.replace(null);\n  };\n\n  EntityStore.prototype.replace = function (newData) {\n    var _this = this;\n\n    Object.keys(this.data).forEach(function (dataId) {\n      if (!(newData && hasOwn.call(newData, dataId))) {\n        _this.delete(dataId);\n      }\n    });\n\n    if (newData) {\n      Object.keys(newData).forEach(function (dataId) {\n        _this.merge(dataId, newData[dataId]);\n      });\n    }\n  };\n\n  EntityStore.prototype.retain = function (rootId) {\n    return this.rootIds[rootId] = (this.rootIds[rootId] || 0) + 1;\n  };\n\n  EntityStore.prototype.release = function (rootId) {\n    if (this.rootIds[rootId] > 0) {\n      var count = --this.rootIds[rootId];\n      if (!count) delete this.rootIds[rootId];\n      return count;\n    }\n\n    return 0;\n  };\n\n  EntityStore.prototype.getRootIdSet = function (ids) {\n    if (ids === void 0) {\n      ids = new Set();\n    }\n\n    Object.keys(this.rootIds).forEach(ids.add, ids);\n\n    if (this instanceof Layer) {\n      this.parent.getRootIdSet(ids);\n    }\n\n    return ids;\n  };\n\n  EntityStore.prototype.gc = function () {\n    var _this = this;\n\n    var ids = this.getRootIdSet();\n    var snapshot = this.toObject();\n    ids.forEach(function (id) {\n      if (hasOwn.call(snapshot, id)) {\n        Object.keys(_this.findChildRefIds(id)).forEach(ids.add, ids);\n        delete snapshot[id];\n      }\n    });\n    var idsToRemove = Object.keys(snapshot);\n\n    if (idsToRemove.length) {\n      var root_1 = this;\n\n      while (root_1 instanceof Layer) root_1 = root_1.parent;\n\n      idsToRemove.forEach(function (id) {\n        return root_1.delete(id);\n      });\n    }\n\n    return idsToRemove;\n  };\n\n  EntityStore.prototype.findChildRefIds = function (dataId) {\n    if (!hasOwn.call(this.refs, dataId)) {\n      var found_1 = this.refs[dataId] = Object.create(null);\n      var workSet_1 = new Set([this.data[dataId]]);\n\n      var canTraverse_1 = function (obj) {\n        return obj !== null && typeof obj === 'object';\n      };\n\n      workSet_1.forEach(function (obj) {\n        if (isReference(obj)) {\n          found_1[obj.__ref] = true;\n        } else if (canTraverse_1(obj)) {\n          Object.values(obj).filter(canTraverse_1).forEach(workSet_1.add, workSet_1);\n        }\n      });\n    }\n\n    return this.refs[dataId];\n  };\n\n  EntityStore.prototype.makeCacheKey = function () {\n    var args = [];\n\n    for (var _i = 0; _i < arguments.length; _i++) {\n      args[_i] = arguments[_i];\n    }\n\n    return this.group.keyMaker.lookupArray(args);\n  };\n\n  return EntityStore;\n}();\n\nexport { EntityStore };\n\nvar CacheGroup = function () {\n  function CacheGroup(caching) {\n    this.caching = caching;\n    this.d = null;\n    this.keyMaker = new KeyTrie(canUseWeakMap);\n    this.d = caching ? dep() : null;\n  }\n\n  CacheGroup.prototype.depend = function (dataId, storeFieldName) {\n    if (this.d) {\n      this.d(makeDepKey(dataId, storeFieldName));\n    }\n  };\n\n  CacheGroup.prototype.dirty = function (dataId, storeFieldName) {\n    if (this.d) {\n      this.d.dirty(makeDepKey(dataId, storeFieldName));\n    }\n  };\n\n  return CacheGroup;\n}();\n\nfunction makeDepKey(dataId, storeFieldName) {\n  return fieldNameFromStoreName(storeFieldName) + '#' + dataId;\n}\n\n(function (EntityStore) {\n  var Root = function (_super) {\n    __extends(Root, _super);\n\n    function Root(_a) {\n      var policies = _a.policies,\n          _b = _a.resultCaching,\n          resultCaching = _b === void 0 ? true : _b,\n          seed = _a.seed;\n\n      var _this = _super.call(this, policies, new CacheGroup(resultCaching)) || this;\n\n      _this.sharedLayerGroup = new CacheGroup(resultCaching);\n      if (seed) _this.replace(seed);\n      return _this;\n    }\n\n    Root.prototype.addLayer = function (layerId, replay) {\n      return new Layer(layerId, this, replay, this.sharedLayerGroup);\n    };\n\n    Root.prototype.removeLayer = function () {\n      return this;\n    };\n\n    return Root;\n  }(EntityStore);\n\n  EntityStore.Root = Root;\n})(EntityStore || (EntityStore = {}));\n\nvar Layer = function (_super) {\n  __extends(Layer, _super);\n\n  function Layer(id, parent, replay, group) {\n    var _this = _super.call(this, parent.policies, group) || this;\n\n    _this.id = id;\n    _this.parent = parent;\n    _this.replay = replay;\n    _this.group = group;\n    replay(_this);\n    return _this;\n  }\n\n  Layer.prototype.addLayer = function (layerId, replay) {\n    return new Layer(layerId, this, replay, this.group);\n  };\n\n  Layer.prototype.removeLayer = function (layerId) {\n    var _this = this;\n\n    var parent = this.parent.removeLayer(layerId);\n\n    if (layerId === this.id) {\n      if (this.group.caching) {\n        Object.keys(this.data).forEach(function (dataId) {\n          if (_this.data[dataId] !== parent.lookup(dataId)) {\n            _this.delete(dataId);\n          }\n        });\n      }\n\n      return parent;\n    }\n\n    if (parent === this.parent) return this;\n    return parent.addLayer(this.id, this.replay);\n  };\n\n  Layer.prototype.toObject = function () {\n    return __assign(__assign({}, this.parent.toObject()), this.data);\n  };\n\n  Layer.prototype.findChildRefIds = function (dataId) {\n    var fromParent = this.parent.findChildRefIds(dataId);\n    return hasOwn.call(this.data, dataId) ? __assign(__assign({}, fromParent), _super.prototype.findChildRefIds.call(this, dataId)) : fromParent;\n  };\n\n  return Layer;\n}(EntityStore);\n\nfunction storeObjectReconciler(existingObject, incomingObject, property) {\n  var existingValue = existingObject[property];\n  var incomingValue = incomingObject[property];\n  return equal(existingValue, incomingValue) ? existingValue : incomingValue;\n}\n\nexport function supportsResultCaching(store) {\n  return !!(store instanceof EntityStore && store.group.caching);\n}","map":{"version":3,"sources":["../../../src/cache/inmemory/entityStore.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign, __extends } from \"tslib\";\nimport { dep, KeyTrie } from 'optimism';\nimport { equal } from '@wry/equality';\nimport { isReference, makeReference, DeepMerger, maybeDeepFreeze, canUseWeakMap, } from \"../../utilities/index.js\";\nimport { hasOwn, fieldNameFromStoreName } from \"./helpers.js\";\nvar DELETE = Object.create(null);\nvar delModifier = function () { return DELETE; };\nvar EntityStore = (function () {\n    function EntityStore(policies, group) {\n        var _this = this;\n        this.policies = policies;\n        this.group = group;\n        this.data = Object.create(null);\n        this.rootIds = Object.create(null);\n        this.refs = Object.create(null);\n        this.getFieldValue = function (objectOrReference, storeFieldName) { return maybeDeepFreeze(isReference(objectOrReference)\n            ? _this.get(objectOrReference.__ref, storeFieldName)\n            : objectOrReference && objectOrReference[storeFieldName]); };\n        this.canRead = function (objOrRef) {\n            return isReference(objOrRef)\n                ? _this.has(objOrRef.__ref)\n                : typeof objOrRef === \"object\";\n        };\n        this.toReference = function (objOrIdOrRef, mergeIntoStore) {\n            if (typeof objOrIdOrRef === \"string\") {\n                return makeReference(objOrIdOrRef);\n            }\n            if (isReference(objOrIdOrRef)) {\n                return objOrIdOrRef;\n            }\n            var id = _this.policies.identify(objOrIdOrRef)[0];\n            if (id) {\n                var ref = makeReference(id);\n                if (mergeIntoStore) {\n                    _this.merge(id, objOrIdOrRef);\n                }\n                return ref;\n            }\n        };\n    }\n    EntityStore.prototype.toObject = function () {\n        return __assign({}, this.data);\n    };\n    EntityStore.prototype.has = function (dataId) {\n        return this.lookup(dataId, true) !== void 0;\n    };\n    EntityStore.prototype.get = function (dataId, fieldName) {\n        this.group.depend(dataId, fieldName);\n        if (hasOwn.call(this.data, dataId)) {\n            var storeObject = this.data[dataId];\n            if (storeObject && hasOwn.call(storeObject, fieldName)) {\n                return storeObject[fieldName];\n            }\n        }\n        if (fieldName === \"__typename\" &&\n            hasOwn.call(this.policies.rootTypenamesById, dataId)) {\n            return this.policies.rootTypenamesById[dataId];\n        }\n        if (this instanceof Layer) {\n            return this.parent.get(dataId, fieldName);\n        }\n    };\n    EntityStore.prototype.lookup = function (dataId, dependOnExistence) {\n        if (dependOnExistence)\n            this.group.depend(dataId, \"__exists\");\n        return hasOwn.call(this.data, dataId) ? this.data[dataId] :\n            this instanceof Layer ? this.parent.lookup(dataId, dependOnExistence) : void 0;\n    };\n    EntityStore.prototype.merge = function (dataId, incoming) {\n        var _this = this;\n        var existing = this.lookup(dataId);\n        var merged = new DeepMerger(storeObjectReconciler).merge(existing, incoming);\n        this.data[dataId] = merged;\n        if (merged !== existing) {\n            delete this.refs[dataId];\n            if (this.group.caching) {\n                var fieldsToDirty_1 = Object.create(null);\n                if (!existing)\n                    fieldsToDirty_1.__exists = 1;\n                Object.keys(incoming).forEach(function (storeFieldName) {\n                    if (!existing || existing[storeFieldName] !== merged[storeFieldName]) {\n                        fieldsToDirty_1[fieldNameFromStoreName(storeFieldName)] = 1;\n                        if (merged[storeFieldName] === void 0 && !(_this instanceof Layer)) {\n                            delete merged[storeFieldName];\n                        }\n                    }\n                });\n                Object.keys(fieldsToDirty_1).forEach(function (fieldName) { return _this.group.dirty(dataId, fieldName); });\n            }\n        }\n    };\n    EntityStore.prototype.modify = function (dataId, fields) {\n        var _this = this;\n        var storeObject = this.lookup(dataId);\n        if (storeObject) {\n            var changedFields_1 = Object.create(null);\n            var needToMerge_1 = false;\n            var allDeleted_1 = true;\n            var readField_1 = function (fieldNameOrOptions, from) { return _this.policies.readField(typeof fieldNameOrOptions === \"string\" ? {\n                fieldName: fieldNameOrOptions,\n                from: from || makeReference(dataId),\n            } : fieldNameOrOptions, { store: _this }); };\n            Object.keys(storeObject).forEach(function (storeFieldName) {\n                var fieldName = fieldNameFromStoreName(storeFieldName);\n                var fieldValue = storeObject[storeFieldName];\n                if (fieldValue === void 0)\n                    return;\n                var modify = typeof fields === \"function\"\n                    ? fields\n                    : fields[storeFieldName] || fields[fieldName];\n                if (modify) {\n                    var newValue = modify === delModifier ? DELETE :\n                        modify(maybeDeepFreeze(fieldValue), {\n                            DELETE: DELETE,\n                            fieldName: fieldName,\n                            storeFieldName: storeFieldName,\n                            isReference: isReference,\n                            toReference: _this.toReference,\n                            canRead: _this.canRead,\n                            readField: readField_1,\n                        });\n                    if (newValue === DELETE)\n                        newValue = void 0;\n                    if (newValue !== fieldValue) {\n                        changedFields_1[storeFieldName] = newValue;\n                        needToMerge_1 = true;\n                        fieldValue = newValue;\n                    }\n                }\n                if (fieldValue !== void 0) {\n                    allDeleted_1 = false;\n                }\n            });\n            if (needToMerge_1) {\n                this.merge(dataId, changedFields_1);\n                if (allDeleted_1) {\n                    if (this instanceof Layer) {\n                        this.data[dataId] = void 0;\n                    }\n                    else {\n                        delete this.data[dataId];\n                    }\n                    this.group.dirty(dataId, \"__exists\");\n                }\n                return true;\n            }\n        }\n        return false;\n    };\n    EntityStore.prototype.delete = function (dataId, fieldName, args) {\n        var _a;\n        var storeObject = this.lookup(dataId);\n        if (storeObject) {\n            var typename = this.getFieldValue(storeObject, \"__typename\");\n            var storeFieldName = fieldName && args\n                ? this.policies.getStoreFieldName({ typename: typename, fieldName: fieldName, args: args })\n                : fieldName;\n            return this.modify(dataId, storeFieldName ? (_a = {},\n                _a[storeFieldName] = delModifier,\n                _a) : delModifier);\n        }\n        return false;\n    };\n    EntityStore.prototype.evict = function (options) {\n        var evicted = false;\n        if (options.id) {\n            if (hasOwn.call(this.data, options.id)) {\n                evicted = this.delete(options.id, options.fieldName, options.args);\n            }\n            if (this instanceof Layer) {\n                evicted = this.parent.evict(options) || evicted;\n            }\n            if (options.fieldName || evicted) {\n                this.group.dirty(options.id, options.fieldName || \"__exists\");\n            }\n        }\n        return evicted;\n    };\n    EntityStore.prototype.clear = function () {\n        this.replace(null);\n    };\n    EntityStore.prototype.replace = function (newData) {\n        var _this = this;\n        Object.keys(this.data).forEach(function (dataId) {\n            if (!(newData && hasOwn.call(newData, dataId))) {\n                _this.delete(dataId);\n            }\n        });\n        if (newData) {\n            Object.keys(newData).forEach(function (dataId) {\n                _this.merge(dataId, newData[dataId]);\n            });\n        }\n    };\n    EntityStore.prototype.retain = function (rootId) {\n        return this.rootIds[rootId] = (this.rootIds[rootId] || 0) + 1;\n    };\n    EntityStore.prototype.release = function (rootId) {\n        if (this.rootIds[rootId] > 0) {\n            var count = --this.rootIds[rootId];\n            if (!count)\n                delete this.rootIds[rootId];\n            return count;\n        }\n        return 0;\n    };\n    EntityStore.prototype.getRootIdSet = function (ids) {\n        if (ids === void 0) { ids = new Set(); }\n        Object.keys(this.rootIds).forEach(ids.add, ids);\n        if (this instanceof Layer) {\n            this.parent.getRootIdSet(ids);\n        }\n        return ids;\n    };\n    EntityStore.prototype.gc = function () {\n        var _this = this;\n        var ids = this.getRootIdSet();\n        var snapshot = this.toObject();\n        ids.forEach(function (id) {\n            if (hasOwn.call(snapshot, id)) {\n                Object.keys(_this.findChildRefIds(id)).forEach(ids.add, ids);\n                delete snapshot[id];\n            }\n        });\n        var idsToRemove = Object.keys(snapshot);\n        if (idsToRemove.length) {\n            var root_1 = this;\n            while (root_1 instanceof Layer)\n                root_1 = root_1.parent;\n            idsToRemove.forEach(function (id) { return root_1.delete(id); });\n        }\n        return idsToRemove;\n    };\n    EntityStore.prototype.findChildRefIds = function (dataId) {\n        if (!hasOwn.call(this.refs, dataId)) {\n            var found_1 = this.refs[dataId] = Object.create(null);\n            var workSet_1 = new Set([this.data[dataId]]);\n            var canTraverse_1 = function (obj) { return obj !== null && typeof obj === 'object'; };\n            workSet_1.forEach(function (obj) {\n                if (isReference(obj)) {\n                    found_1[obj.__ref] = true;\n                }\n                else if (canTraverse_1(obj)) {\n                    Object.values(obj)\n                        .filter(canTraverse_1)\n                        .forEach(workSet_1.add, workSet_1);\n                }\n            });\n        }\n        return this.refs[dataId];\n    };\n    EntityStore.prototype.makeCacheKey = function () {\n        var args = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n            args[_i] = arguments[_i];\n        }\n        return this.group.keyMaker.lookupArray(args);\n    };\n    return EntityStore;\n}());\nexport { EntityStore };\nvar CacheGroup = (function () {\n    function CacheGroup(caching) {\n        this.caching = caching;\n        this.d = null;\n        this.keyMaker = new KeyTrie(canUseWeakMap);\n        this.d = caching ? dep() : null;\n    }\n    CacheGroup.prototype.depend = function (dataId, storeFieldName) {\n        if (this.d) {\n            this.d(makeDepKey(dataId, storeFieldName));\n        }\n    };\n    CacheGroup.prototype.dirty = function (dataId, storeFieldName) {\n        if (this.d) {\n            this.d.dirty(makeDepKey(dataId, storeFieldName));\n        }\n    };\n    return CacheGroup;\n}());\nfunction makeDepKey(dataId, storeFieldName) {\n    return fieldNameFromStoreName(storeFieldName) + '#' + dataId;\n}\n(function (EntityStore) {\n    var Root = (function (_super) {\n        __extends(Root, _super);\n        function Root(_a) {\n            var policies = _a.policies, _b = _a.resultCaching, resultCaching = _b === void 0 ? true : _b, seed = _a.seed;\n            var _this = _super.call(this, policies, new CacheGroup(resultCaching)) || this;\n            _this.sharedLayerGroup = new CacheGroup(resultCaching);\n            if (seed)\n                _this.replace(seed);\n            return _this;\n        }\n        Root.prototype.addLayer = function (layerId, replay) {\n            return new Layer(layerId, this, replay, this.sharedLayerGroup);\n        };\n        Root.prototype.removeLayer = function () {\n            return this;\n        };\n        return Root;\n    }(EntityStore));\n    EntityStore.Root = Root;\n})(EntityStore || (EntityStore = {}));\nvar Layer = (function (_super) {\n    __extends(Layer, _super);\n    function Layer(id, parent, replay, group) {\n        var _this = _super.call(this, parent.policies, group) || this;\n        _this.id = id;\n        _this.parent = parent;\n        _this.replay = replay;\n        _this.group = group;\n        replay(_this);\n        return _this;\n    }\n    Layer.prototype.addLayer = function (layerId, replay) {\n        return new Layer(layerId, this, replay, this.group);\n    };\n    Layer.prototype.removeLayer = function (layerId) {\n        var _this = this;\n        var parent = this.parent.removeLayer(layerId);\n        if (layerId === this.id) {\n            if (this.group.caching) {\n                Object.keys(this.data).forEach(function (dataId) {\n                    if (_this.data[dataId] !== parent.lookup(dataId)) {\n                        _this.delete(dataId);\n                    }\n                });\n            }\n            return parent;\n        }\n        if (parent === this.parent)\n            return this;\n        return parent.addLayer(this.id, this.replay);\n    };\n    Layer.prototype.toObject = function () {\n        return __assign(__assign({}, this.parent.toObject()), this.data);\n    };\n    Layer.prototype.findChildRefIds = function (dataId) {\n        var fromParent = this.parent.findChildRefIds(dataId);\n        return hasOwn.call(this.data, dataId) ? __assign(__assign({}, fromParent), _super.prototype.findChildRefIds.call(this, dataId)) : fromParent;\n    };\n    return Layer;\n}(EntityStore));\nfunction storeObjectReconciler(existingObject, incomingObject, property) {\n    var existingValue = existingObject[property];\n    var incomingValue = incomingObject[property];\n    return equal(existingValue, incomingValue) ? existingValue : incomingValue;\n}\nexport function supportsResultCaching(store) {\n    return !!(store instanceof EntityStore && store.group.caching);\n}\n//# sourceMappingURL=entityStore.js.map"]},"metadata":{},"sourceType":"module"}