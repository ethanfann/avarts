{"ast":null,"code":"import { __assign, __extends } from \"tslib\";\nimport { equal } from '@wry/equality';\nimport { ApolloError } from \"../../errors/index.js\";\nimport { NetworkStatus } from \"../../core/index.js\";\nimport { DocumentType } from \"../parser/index.js\";\nimport { OperationData } from \"./OperationData.js\";\n\nvar QueryData = function (_super) {\n  __extends(QueryData, _super);\n\n  function QueryData(_a) {\n    var options = _a.options,\n        context = _a.context,\n        onNewData = _a.onNewData;\n\n    var _this = _super.call(this, options, context) || this;\n\n    _this.previousData = {};\n    _this.runLazy = false;\n\n    _this.runLazyQuery = function (options) {\n      _this.cleanup();\n\n      _this.runLazy = true;\n      _this.lazyOptions = options;\n\n      _this.onNewData();\n    };\n\n    _this.getQueryResult = function () {\n      var result = _this.observableQueryFields();\n\n      var options = _this.getOptions();\n\n      if (options.skip) {\n        result = __assign(__assign({}, result), {\n          data: undefined,\n          error: undefined,\n          loading: false,\n          called: true\n        });\n      } else if (_this.currentObservable) {\n        var currentResult = _this.currentObservable.getCurrentResult();\n\n        var data = currentResult.data,\n            loading = currentResult.loading,\n            partial = currentResult.partial,\n            networkStatus = currentResult.networkStatus,\n            errors = currentResult.errors;\n        var error = currentResult.error;\n\n        if (errors && errors.length > 0) {\n          error = new ApolloError({\n            graphQLErrors: errors\n          });\n        }\n\n        result = __assign(__assign({}, result), {\n          data: data,\n          loading: loading,\n          networkStatus: networkStatus,\n          error: error,\n          called: true\n        });\n\n        if (loading) {} else if (error) {\n          Object.assign(result, {\n            data: (_this.currentObservable.getLastResult() || {}).data\n          });\n        } else {\n          var fetchPolicy = _this.currentObservable.options.fetchPolicy;\n          var partialRefetch = options.partialRefetch;\n\n          if (partialRefetch && partial && (!data || Object.keys(data).length === 0) && fetchPolicy !== 'cache-only') {\n            Object.assign(result, {\n              loading: true,\n              networkStatus: NetworkStatus.loading\n            });\n            result.refetch();\n            return result;\n          }\n        }\n      }\n\n      result.client = _this.client;\n\n      _this.setOptions(options, true);\n\n      _this.previousData.loading = _this.previousData.result && _this.previousData.result.loading || false;\n      _this.previousData.result = result;\n      _this.currentObservable && _this.currentObservable.resetQueryStoreErrors();\n      return result;\n    };\n\n    _this.obsRefetch = function (variables) {\n      return _this.currentObservable.refetch(variables);\n    };\n\n    _this.obsFetchMore = function (fetchMoreOptions) {\n      return _this.currentObservable.fetchMore(fetchMoreOptions);\n    };\n\n    _this.obsUpdateQuery = function (mapFn) {\n      return _this.currentObservable.updateQuery(mapFn);\n    };\n\n    _this.obsStartPolling = function (pollInterval) {\n      var _a;\n\n      (_a = _this.currentObservable) === null || _a === void 0 ? void 0 : _a.startPolling(pollInterval);\n    };\n\n    _this.obsStopPolling = function () {\n      var _a;\n\n      (_a = _this.currentObservable) === null || _a === void 0 ? void 0 : _a.stopPolling();\n    };\n\n    _this.obsSubscribeToMore = function (options) {\n      return _this.currentObservable.subscribeToMore(options);\n    };\n\n    _this.onNewData = onNewData;\n    return _this;\n  }\n\n  QueryData.prototype.execute = function () {\n    this.refreshClient();\n\n    var _a = this.getOptions(),\n        skip = _a.skip,\n        query = _a.query;\n\n    if (skip || query !== this.previousData.query) {\n      this.removeQuerySubscription();\n      this.previousData.query = query;\n    }\n\n    this.updateObservableQuery();\n    if (this.isMounted) this.startQuerySubscription();\n    return this.getExecuteSsrResult() || this.getExecuteResult();\n  };\n\n  QueryData.prototype.executeLazy = function () {\n    return !this.runLazy ? [this.runLazyQuery, {\n      loading: false,\n      networkStatus: NetworkStatus.ready,\n      called: false,\n      data: undefined\n    }] : [this.runLazyQuery, this.execute()];\n  };\n\n  QueryData.prototype.fetchData = function () {\n    var _this = this;\n\n    var options = this.getOptions();\n    if (options.skip || options.ssr === false) return false;\n    return new Promise(function (resolve) {\n      return _this.startQuerySubscription(resolve);\n    });\n  };\n\n  QueryData.prototype.afterExecute = function (_a) {\n    var _b = (_a === void 0 ? {} : _a).lazy,\n        lazy = _b === void 0 ? false : _b;\n    this.isMounted = true;\n\n    if (!lazy || this.runLazy) {\n      this.handleErrorOrCompleted();\n    }\n\n    this.previousOptions = this.getOptions();\n    return this.unmount.bind(this);\n  };\n\n  QueryData.prototype.cleanup = function () {\n    this.removeQuerySubscription();\n    delete this.currentObservable;\n    delete this.previousData.result;\n  };\n\n  QueryData.prototype.getOptions = function () {\n    var options = _super.prototype.getOptions.call(this);\n\n    if (this.lazyOptions) {\n      options.variables = __assign(__assign({}, options.variables), this.lazyOptions.variables);\n      options.context = __assign(__assign({}, options.context), this.lazyOptions.context);\n    }\n\n    if (this.runLazy) {\n      delete options.skip;\n    }\n\n    return options;\n  };\n\n  QueryData.prototype.ssrInitiated = function () {\n    return this.context && this.context.renderPromises;\n  };\n\n  QueryData.prototype.getExecuteResult = function () {\n    var result = this.getQueryResult();\n    this.startQuerySubscription();\n    return result;\n  };\n\n  ;\n\n  QueryData.prototype.getExecuteSsrResult = function () {\n    var ssrDisabled = this.getOptions().ssr === false;\n    var fetchDisabled = this.refreshClient().client.disableNetworkFetches;\n\n    var ssrLoading = __assign({\n      loading: true,\n      networkStatus: NetworkStatus.loading,\n      called: true,\n      data: undefined,\n      stale: false,\n      client: this.client\n    }, this.observableQueryFields());\n\n    if (ssrDisabled && (this.ssrInitiated() || fetchDisabled)) {\n      this.previousData.result = ssrLoading;\n      return ssrLoading;\n    }\n\n    var result;\n\n    if (this.ssrInitiated()) {\n      result = this.context.renderPromises.addQueryPromise(this, this.getQueryResult) || ssrLoading;\n    }\n\n    return result;\n  };\n\n  QueryData.prototype.prepareObservableQueryOptions = function () {\n    var options = this.getOptions();\n    this.verifyDocumentType(options.query, DocumentType.Query);\n    var displayName = options.displayName || 'Query';\n\n    if (this.ssrInitiated() && (options.fetchPolicy === 'network-only' || options.fetchPolicy === 'cache-and-network')) {\n      options.fetchPolicy = 'cache-first';\n    }\n\n    return __assign(__assign({}, options), {\n      displayName: displayName,\n      context: options.context\n    });\n  };\n\n  QueryData.prototype.initializeObservableQuery = function () {\n    if (this.ssrInitiated()) {\n      this.currentObservable = this.context.renderPromises.getSSRObservable(this.getOptions());\n    }\n\n    if (!this.currentObservable) {\n      var observableQueryOptions = this.prepareObservableQueryOptions();\n      this.previousData.observableQueryOptions = __assign(__assign({}, observableQueryOptions), {\n        children: null\n      });\n      this.currentObservable = this.refreshClient().client.watchQuery(__assign({}, observableQueryOptions));\n\n      if (this.ssrInitiated()) {\n        this.context.renderPromises.registerSSRObservable(this.currentObservable, observableQueryOptions);\n      }\n    }\n  };\n\n  QueryData.prototype.updateObservableQuery = function () {\n    if (this.getOptions().skip) return;\n\n    if (!this.currentObservable) {\n      this.initializeObservableQuery();\n      return;\n    }\n\n    var newObservableQueryOptions = __assign(__assign({}, this.prepareObservableQueryOptions()), {\n      children: null\n    });\n\n    if (!equal(newObservableQueryOptions, this.previousData.observableQueryOptions)) {\n      this.previousData.observableQueryOptions = newObservableQueryOptions;\n      this.currentObservable.setOptions(newObservableQueryOptions).catch(function () {});\n    }\n  };\n\n  QueryData.prototype.startQuerySubscription = function (onNewData) {\n    var _this = this;\n\n    if (onNewData === void 0) {\n      onNewData = this.onNewData;\n    }\n\n    if (this.currentSubscription || this.getOptions().skip) return;\n    this.currentSubscription = this.currentObservable.subscribe({\n      next: function (_a) {\n        var loading = _a.loading,\n            networkStatus = _a.networkStatus,\n            data = _a.data;\n        var previousResult = _this.previousData.result;\n\n        if (previousResult && previousResult.loading === loading && previousResult.networkStatus === networkStatus && equal(previousResult.data, data)) {\n          return;\n        }\n\n        onNewData();\n      },\n      error: function (error) {\n        _this.resubscribeToQuery();\n\n        if (!error.hasOwnProperty('graphQLErrors')) throw error;\n        var previousResult = _this.previousData.result;\n\n        if (previousResult && previousResult.loading || !equal(error, _this.previousData.error)) {\n          _this.previousData.error = error;\n          onNewData();\n        }\n      }\n    });\n  };\n\n  QueryData.prototype.resubscribeToQuery = function () {\n    this.removeQuerySubscription();\n    var currentObservable = this.currentObservable;\n\n    if (currentObservable) {\n      var lastError = currentObservable.getLastError();\n      var lastResult = currentObservable.getLastResult();\n      currentObservable.resetLastResults();\n      this.startQuerySubscription();\n      Object.assign(currentObservable, {\n        lastError: lastError,\n        lastResult: lastResult\n      });\n    }\n  };\n\n  QueryData.prototype.handleErrorOrCompleted = function () {\n    if (!this.currentObservable || !this.previousData.result) return;\n    var _a = this.previousData.result,\n        data = _a.data,\n        loading = _a.loading,\n        error = _a.error;\n\n    if (!loading) {\n      var _b = this.getOptions(),\n          query = _b.query,\n          variables = _b.variables,\n          onCompleted = _b.onCompleted,\n          onError = _b.onError,\n          skip = _b.skip;\n\n      if (this.previousOptions && !this.previousData.loading && equal(this.previousOptions.query, query) && equal(this.previousOptions.variables, variables)) {\n        return;\n      }\n\n      if (onCompleted && !error && !skip) {\n        onCompleted(data);\n      } else if (onError && error) {\n        onError(error);\n      }\n    }\n  };\n\n  QueryData.prototype.removeQuerySubscription = function () {\n    if (this.currentSubscription) {\n      this.currentSubscription.unsubscribe();\n      delete this.currentSubscription;\n    }\n  };\n\n  QueryData.prototype.observableQueryFields = function () {\n    var _a;\n\n    return {\n      variables: (_a = this.currentObservable) === null || _a === void 0 ? void 0 : _a.variables,\n      refetch: this.obsRefetch,\n      fetchMore: this.obsFetchMore,\n      updateQuery: this.obsUpdateQuery,\n      startPolling: this.obsStartPolling,\n      stopPolling: this.obsStopPolling,\n      subscribeToMore: this.obsSubscribeToMore\n    };\n  };\n\n  return QueryData;\n}(OperationData);\n\nexport { QueryData };","map":{"version":3,"sources":["../../../src/react/data/QueryData.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign, __extends } from \"tslib\";\nimport { equal } from '@wry/equality';\nimport { ApolloError } from \"../../errors/index.js\";\nimport { NetworkStatus } from \"../../core/index.js\";\nimport { DocumentType } from \"../parser/index.js\";\nimport { OperationData } from \"./OperationData.js\";\nvar QueryData = (function (_super) {\n    __extends(QueryData, _super);\n    function QueryData(_a) {\n        var options = _a.options, context = _a.context, onNewData = _a.onNewData;\n        var _this = _super.call(this, options, context) || this;\n        _this.previousData = {};\n        _this.runLazy = false;\n        _this.runLazyQuery = function (options) {\n            _this.cleanup();\n            _this.runLazy = true;\n            _this.lazyOptions = options;\n            _this.onNewData();\n        };\n        _this.getQueryResult = function () {\n            var result = _this.observableQueryFields();\n            var options = _this.getOptions();\n            if (options.skip) {\n                result = __assign(__assign({}, result), { data: undefined, error: undefined, loading: false, called: true });\n            }\n            else if (_this.currentObservable) {\n                var currentResult = _this.currentObservable.getCurrentResult();\n                var data = currentResult.data, loading = currentResult.loading, partial = currentResult.partial, networkStatus = currentResult.networkStatus, errors = currentResult.errors;\n                var error = currentResult.error;\n                if (errors && errors.length > 0) {\n                    error = new ApolloError({ graphQLErrors: errors });\n                }\n                result = __assign(__assign({}, result), { data: data,\n                    loading: loading,\n                    networkStatus: networkStatus,\n                    error: error, called: true });\n                if (loading) {\n                }\n                else if (error) {\n                    Object.assign(result, {\n                        data: (_this.currentObservable.getLastResult() || {})\n                            .data\n                    });\n                }\n                else {\n                    var fetchPolicy = _this.currentObservable.options.fetchPolicy;\n                    var partialRefetch = options.partialRefetch;\n                    if (partialRefetch &&\n                        partial &&\n                        (!data || Object.keys(data).length === 0) &&\n                        fetchPolicy !== 'cache-only') {\n                        Object.assign(result, {\n                            loading: true,\n                            networkStatus: NetworkStatus.loading\n                        });\n                        result.refetch();\n                        return result;\n                    }\n                }\n            }\n            result.client = _this.client;\n            _this.setOptions(options, true);\n            _this.previousData.loading =\n                _this.previousData.result && _this.previousData.result.loading || false;\n            _this.previousData.result = result;\n            _this.currentObservable && _this.currentObservable.resetQueryStoreErrors();\n            return result;\n        };\n        _this.obsRefetch = function (variables) {\n            return _this.currentObservable.refetch(variables);\n        };\n        _this.obsFetchMore = function (fetchMoreOptions) { return _this.currentObservable.fetchMore(fetchMoreOptions); };\n        _this.obsUpdateQuery = function (mapFn) { return _this.currentObservable.updateQuery(mapFn); };\n        _this.obsStartPolling = function (pollInterval) {\n            var _a;\n            (_a = _this.currentObservable) === null || _a === void 0 ? void 0 : _a.startPolling(pollInterval);\n        };\n        _this.obsStopPolling = function () {\n            var _a;\n            (_a = _this.currentObservable) === null || _a === void 0 ? void 0 : _a.stopPolling();\n        };\n        _this.obsSubscribeToMore = function (options) { return _this.currentObservable.subscribeToMore(options); };\n        _this.onNewData = onNewData;\n        return _this;\n    }\n    QueryData.prototype.execute = function () {\n        this.refreshClient();\n        var _a = this.getOptions(), skip = _a.skip, query = _a.query;\n        if (skip || query !== this.previousData.query) {\n            this.removeQuerySubscription();\n            this.previousData.query = query;\n        }\n        this.updateObservableQuery();\n        if (this.isMounted)\n            this.startQuerySubscription();\n        return this.getExecuteSsrResult() || this.getExecuteResult();\n    };\n    QueryData.prototype.executeLazy = function () {\n        return !this.runLazy\n            ? [\n                this.runLazyQuery,\n                {\n                    loading: false,\n                    networkStatus: NetworkStatus.ready,\n                    called: false,\n                    data: undefined\n                }\n            ]\n            : [this.runLazyQuery, this.execute()];\n    };\n    QueryData.prototype.fetchData = function () {\n        var _this = this;\n        var options = this.getOptions();\n        if (options.skip || options.ssr === false)\n            return false;\n        return new Promise(function (resolve) { return _this.startQuerySubscription(resolve); });\n    };\n    QueryData.prototype.afterExecute = function (_a) {\n        var _b = (_a === void 0 ? {} : _a).lazy, lazy = _b === void 0 ? false : _b;\n        this.isMounted = true;\n        if (!lazy || this.runLazy) {\n            this.handleErrorOrCompleted();\n        }\n        this.previousOptions = this.getOptions();\n        return this.unmount.bind(this);\n    };\n    QueryData.prototype.cleanup = function () {\n        this.removeQuerySubscription();\n        delete this.currentObservable;\n        delete this.previousData.result;\n    };\n    QueryData.prototype.getOptions = function () {\n        var options = _super.prototype.getOptions.call(this);\n        if (this.lazyOptions) {\n            options.variables = __assign(__assign({}, options.variables), this.lazyOptions.variables);\n            options.context = __assign(__assign({}, options.context), this.lazyOptions.context);\n        }\n        if (this.runLazy) {\n            delete options.skip;\n        }\n        return options;\n    };\n    QueryData.prototype.ssrInitiated = function () {\n        return this.context && this.context.renderPromises;\n    };\n    QueryData.prototype.getExecuteResult = function () {\n        var result = this.getQueryResult();\n        this.startQuerySubscription();\n        return result;\n    };\n    ;\n    QueryData.prototype.getExecuteSsrResult = function () {\n        var ssrDisabled = this.getOptions().ssr === false;\n        var fetchDisabled = this.refreshClient().client.disableNetworkFetches;\n        var ssrLoading = __assign({ loading: true, networkStatus: NetworkStatus.loading, called: true, data: undefined, stale: false, client: this.client }, this.observableQueryFields());\n        if (ssrDisabled && (this.ssrInitiated() || fetchDisabled)) {\n            this.previousData.result = ssrLoading;\n            return ssrLoading;\n        }\n        var result;\n        if (this.ssrInitiated()) {\n            result =\n                this.context.renderPromises.addQueryPromise(this, this.getQueryResult) || ssrLoading;\n        }\n        return result;\n    };\n    QueryData.prototype.prepareObservableQueryOptions = function () {\n        var options = this.getOptions();\n        this.verifyDocumentType(options.query, DocumentType.Query);\n        var displayName = options.displayName || 'Query';\n        if (this.ssrInitiated() &&\n            (options.fetchPolicy === 'network-only' ||\n                options.fetchPolicy === 'cache-and-network')) {\n            options.fetchPolicy = 'cache-first';\n        }\n        return __assign(__assign({}, options), { displayName: displayName, context: options.context });\n    };\n    QueryData.prototype.initializeObservableQuery = function () {\n        if (this.ssrInitiated()) {\n            this.currentObservable = this.context.renderPromises.getSSRObservable(this.getOptions());\n        }\n        if (!this.currentObservable) {\n            var observableQueryOptions = this.prepareObservableQueryOptions();\n            this.previousData.observableQueryOptions = __assign(__assign({}, observableQueryOptions), { children: null });\n            this.currentObservable = this.refreshClient().client.watchQuery(__assign({}, observableQueryOptions));\n            if (this.ssrInitiated()) {\n                this.context.renderPromises.registerSSRObservable(this.currentObservable, observableQueryOptions);\n            }\n        }\n    };\n    QueryData.prototype.updateObservableQuery = function () {\n        if (this.getOptions().skip)\n            return;\n        if (!this.currentObservable) {\n            this.initializeObservableQuery();\n            return;\n        }\n        var newObservableQueryOptions = __assign(__assign({}, this.prepareObservableQueryOptions()), { children: null });\n        if (!equal(newObservableQueryOptions, this.previousData.observableQueryOptions)) {\n            this.previousData.observableQueryOptions = newObservableQueryOptions;\n            this.currentObservable\n                .setOptions(newObservableQueryOptions)\n                .catch(function () { });\n        }\n    };\n    QueryData.prototype.startQuerySubscription = function (onNewData) {\n        var _this = this;\n        if (onNewData === void 0) { onNewData = this.onNewData; }\n        if (this.currentSubscription || this.getOptions().skip)\n            return;\n        this.currentSubscription = this.currentObservable.subscribe({\n            next: function (_a) {\n                var loading = _a.loading, networkStatus = _a.networkStatus, data = _a.data;\n                var previousResult = _this.previousData.result;\n                if (previousResult &&\n                    previousResult.loading === loading &&\n                    previousResult.networkStatus === networkStatus &&\n                    equal(previousResult.data, data)) {\n                    return;\n                }\n                onNewData();\n            },\n            error: function (error) {\n                _this.resubscribeToQuery();\n                if (!error.hasOwnProperty('graphQLErrors'))\n                    throw error;\n                var previousResult = _this.previousData.result;\n                if ((previousResult && previousResult.loading) ||\n                    !equal(error, _this.previousData.error)) {\n                    _this.previousData.error = error;\n                    onNewData();\n                }\n            }\n        });\n    };\n    QueryData.prototype.resubscribeToQuery = function () {\n        this.removeQuerySubscription();\n        var currentObservable = this.currentObservable;\n        if (currentObservable) {\n            var lastError = currentObservable.getLastError();\n            var lastResult = currentObservable.getLastResult();\n            currentObservable.resetLastResults();\n            this.startQuerySubscription();\n            Object.assign(currentObservable, {\n                lastError: lastError,\n                lastResult: lastResult\n            });\n        }\n    };\n    QueryData.prototype.handleErrorOrCompleted = function () {\n        if (!this.currentObservable || !this.previousData.result)\n            return;\n        var _a = this.previousData.result, data = _a.data, loading = _a.loading, error = _a.error;\n        if (!loading) {\n            var _b = this.getOptions(), query = _b.query, variables = _b.variables, onCompleted = _b.onCompleted, onError = _b.onError, skip = _b.skip;\n            if (this.previousOptions &&\n                !this.previousData.loading &&\n                equal(this.previousOptions.query, query) &&\n                equal(this.previousOptions.variables, variables)) {\n                return;\n            }\n            if (onCompleted && !error && !skip) {\n                onCompleted(data);\n            }\n            else if (onError && error) {\n                onError(error);\n            }\n        }\n    };\n    QueryData.prototype.removeQuerySubscription = function () {\n        if (this.currentSubscription) {\n            this.currentSubscription.unsubscribe();\n            delete this.currentSubscription;\n        }\n    };\n    QueryData.prototype.observableQueryFields = function () {\n        var _a;\n        return {\n            variables: (_a = this.currentObservable) === null || _a === void 0 ? void 0 : _a.variables,\n            refetch: this.obsRefetch,\n            fetchMore: this.obsFetchMore,\n            updateQuery: this.obsUpdateQuery,\n            startPolling: this.obsStartPolling,\n            stopPolling: this.obsStopPolling,\n            subscribeToMore: this.obsSubscribeToMore\n        };\n    };\n    return QueryData;\n}(OperationData));\nexport { QueryData };\n//# sourceMappingURL=QueryData.js.map"]},"metadata":{},"sourceType":"module"}